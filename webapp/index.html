<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Daily Drone Report (Preview-first)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { --bg:#f7f7f8; --card:#fff; --muted:#666; --line:#e5e7eb; --accent:#2a7ade; }
    body { font-family: system-ui, Arial, sans-serif; margin: 16px; background: var(--bg); }
    h2,h3 { margin: 0 0 12px; }
    .card { background: var(--card); border-radius: 12px; padding: 14px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,.06); }
    label { display: block; font-weight: 600; margin-top: 10px; }
    input, select, textarea { width: 100%; padding: 8px; margin-top: 6px; border: 1px solid #ddd; border-radius: 8px; }
    button { padding: 10px 14px; border: 0; border-radius: 8px; background: var(--accent); color: #fff; font-weight: 600; cursor: pointer; }
    button.link { background: #666; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .flex { display: flex; gap: 8px; align-items: center; }
    .right { margin-left: auto; }
    .muted { color: var(--muted); font-size: 12px; }
    .flight { border: 1px dashed #cfd8dc; padding: 10px; border-radius: 8px; margin-top: 8px; }
    .error { color: #b00020; font-size: 12px; margin-top: 4px; }
    .hidden { display: none; }
    .divider { height:1px; background:var(--line); margin:8px 0; }
    .mono { font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }
  </style>
</head>
<body>
  <h2>Daily Drone Report</h2>

  <!-- FORM -->
  <div id="form_card" class="card">
    <div class="row">
      <div>
        <label>Date</label>
        <input type="date" id="report_date" />
        <div class="error" id="err_report_date"></div>
      </div>
      <div>
        <label>Base Height (m)</label>
        <input type="number" id="base_height_m" min="0" step="0.01" />
        <div class="error" id="err_base_height_m"></div>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Site</label>
        <select id="site_id"></select>
        <div class="error" id="err_site_id"></div>
      </div>
      <div>
        <label>Drone</label>
        <select id="drone_id"></select>
        <div class="error" id="err_drone_id"></div>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Pilot</label>
        <input type="text" id="pilot_name" placeholder="Pilot Name" />
        <div class="error" id="err_pilot_name"></div>
      </div>
      <div>
        <label>Copilot</label>
        <input type="text" id="copilot_name" placeholder="Copilot Name" />
        <div class="error" id="err_copilot_name"></div>
      </div>
    </div>

    <label>DGPS Used (comma-separated)</label>
    <input type="text" id="dgps_used" placeholder="R4S - 314,DA2 - 739" />
    <div class="muted">Use commas only. "A B" is invalid; "A,B" is valid.</div>
    <div class="error" id="err_dgps_used"></div>

    <label>DGPS Operators (comma-separated)</label>
    <input type="text" id="dgps_ops" placeholder="Alice,Bob" />
    <div class="muted">Use commas only. "Alice Bob" is invalid; "Alice,Bob" is valid.</div>
    <div class="error" id="err_dgps_ops"></div>

    <label>Grid Numbers / Block (comma-separated)</label>
    <input type="text" id="grid_numbers" placeholder="H43R12A17,H43R12A22" />
    <div class="muted">Use commas only. No spaces as separators.</div>
    <div class="error" id="err_grid_numbers"></div>

    <label>GCP Points Covered (comma-separated)</label>
    <input type="text" id="gcp_points" placeholder="CP1,CP2,CK1,CK2" />
    <div class="muted">Use commas only. No spaces as separators.</div>
    <div class="error" id="err_gcp_points"></div>

    <div class="divider"></div>

    <div class="flex">
      <h3 style="margin:0">Flights</h3>
      <button class="right" id="btn_add_flight">+ Add Flight</button>
    </div>
    <div id="flights"></div>
    <div class="error" id="err_flights"></div>

    <div class="divider"></div>

    <label>Remark</label>
    <textarea id="remark" rows="3" placeholder="Short remark"></textarea>
    <div class="error" id="err_remark"></div>

    <div class="divider"></div>

    <div class="flex">
      <button id="btn_preview">Preview</button>
      <button class="link right" id="btn_close">Close</button>
    </div>
  </div>

  <!-- PREVIEW -->
  <div id="preview_card" class="card hidden">
    <h3>Preview</h3>
    <div id="preview_content" class="mono"></div>
    <div class="divider"></div>
    <div class="flex">
      <button id="btn_confirm">Confirm & Send</button>
      <button class="link right" id="btn_edit">Edit</button>
    </div>
    <div class="muted" style="margin-top:8px;">
      * Submission endpoint is disabled in this phase. This is a preview-only demo.
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    tg?.expand();

    // ---- VERIFY SESSION (only employees can proceed) ----
    async function verifySession() {
      const initData = tg?.initData || '';
      const res = await fetch('/api/verify', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ init_data: initData })
      });
      if (!res.ok) {
        const d = await res.json().catch(()=>({detail:'verify failed'}));
        alert('Access denied: ' + (d.detail || 'verify failed'));
        tg?.close();
        throw new Error('verify failed');
      }
      return res.json();
    }

    // ---- Masters ----
    async function loadMasters() {
      const res = await fetch('/api/masters');
      const data = await res.json();
      if (!data.ok) { throw new Error('Failed to load masters'); }
      fillSelect(document.getElementById('site_id'), data.sites);
      fillSelect(document.getElementById('drone_id'), data.drones);
    }

    function fillSelect(sel, items) {
      sel.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = '-- Select --';
      sel.appendChild(opt0);
      (items || []).forEach(i => {
        const o = document.createElement('option');
        o.value = i.id;
        o.textContent = i.name;
        sel.appendChild(o);
      });
    }

    // ---- Flights UI ----
    function addFlightRow() {
      const wrap = document.getElementById('flights');
      const div = document.createElement('div');
      div.className = 'flight';
      div.innerHTML = `
        <div class="row">
          <div>
            <label>Flight Time (min)</label>
            <input type="number" class="f_time" min="1" step="1" />
          </div>
          <div>
            <label>Area (sq km)</label>
            <input type="number" class="f_area" min="0.001" step="0.001" />
          </div>
        </div>
        <label>UAV Rover File (UBX No)</label>
        <input type="text" class="f_ubx" placeholder="UBX..." />
        <label>Drone Base File No</label>
        <input type="text" class="f_base" placeholder="Base file..." />
        <div class="flex" style="margin-top:8px;">
          <span class="muted">Flight</span>
          <button class="link right" onclick="this.closest('.flight').remove();">Remove</button>
        </div>
      `;
      wrap.appendChild(div);
    }

    document.getElementById('btn_add_flight').addEventListener('click', addFlightRow);
    document.getElementById('btn_close').addEventListener('click', () => tg?.close());

    // ---- Validators ----
    function requireValue(id) {
      const v = document.getElementById(id).value.trim();
      return v.length ? null : 'Required';
    }
    function requireNumber(id, minVal) {
      const v = Number(document.getElementById(id).value);
      if (isNaN(v)) return 'Required number';
      if (v < minVal) return `Must be ≥ ${minVal}`;
      return null;
    }
    // Comma-only list: if multiple tokens are present but **no comma**, error.
    function parseCommaListStrict(id) {
      const raw = document.getElementById(id).value.trim();
      if (!raw) return { list: [], error: 'Required' };
      const hasComma = raw.includes(',');
      const spaceTokens = raw.trim().split(/\s+/).filter(Boolean);
      if (spaceTokens.length > 1 && !hasComma) {
        return { list: [], error: 'Use commas to separate values (no spaces as separators)' };
      }
      const list = raw.split(',').map(s => s.trim()).filter(Boolean);
      if (list.length === 0) return { list: [], error: 'At least one value required' };
      return { list, error: null };
    }
    function validateFlights() {
      const flights = Array.from(document.querySelectorAll('.flight')).map(div => ({
        t: Number(div.querySelector('.f_time').value),
        a: Number(div.querySelector('.f_area').value),
        u: div.querySelector('.f_ubx').value.trim(),
        b: div.querySelector('.f_base').value.trim()
      }));
      if (flights.length === 0) return { flights: [], error: 'Add at least one flight' };
      for (const f of flights) {
        if (!f.t || f.t < 1) return { flights: [], error: 'Each flight time must be ≥ 1' };
        if (!f.a || f.a <= 0) return { flights: [], error: 'Each area must be > 0' };
        if (!f.u) return { flights: [], error: 'UAV Rover File required' };
        if (!f.b) return { flights: [], error: 'Drone Base File No required' };
      }
      return { flights, error: null };
    }

    function setErr(id, msg) {
      document.getElementById(id).textContent = msg || '';
    }

    function collectAndValidate() {
      // clear errors
      ['err_report_date','err_base_height_m','err_site_id','err_drone_id','err_pilot_name','err_copilot_name',
       'err_dgps_used','err_dgps_ops','err_grid_numbers','err_gcp_points','err_flights','err_remark']
       .forEach(id => setErr(id, ''));

      const e = {};
      e.report_date = requireValue('report_date');
      e.base_height_m = requireNumber('base_height_m', 0);
      e.site_id = requireValue('site_id');
      e.drone_id = requireValue('drone_id');
      e.pilot_name = requireValue('pilot_name');
      e.copilot_name = requireValue('copilot_name');

      const dgps_used = parseCommaListStrict('dgps_used');
      const dgps_ops  = parseCommaListStrict('dgps_ops');
      const grids     = parseCommaListStrict('grid_numbers');
      const gcps      = parseCommaListStrict('gcp_points');

      const flights   = validateFlights();

      const remark = requireValue('remark');

      // Show errors
      setErr('err_report_date', e.report_date);
      setErr('err_base_height_m', e.base_height_m);
      setErr('err_site_id', e.site_id);
      setErr('err_drone_id', e.drone_id);
      setErr('err_pilot_name', e.pilot_name);
      setErr('err_copilot_name', e.copilot_name);
      setErr('err_dgps_used', dgps_used.error);
      setErr('err_dgps_ops', dgps_ops.error);
      setErr('err_grid_numbers', grids.error);
      setErr('err_gcp_points', gcps.error);
      setErr('err_flights', flights.error);
      setErr('err_remark', remark);

      const anyErr = [
        e.report_date, e.base_height_m, e.site_id, e.drone_id, e.pilot_name, e.copilot_name,
        dgps_used.error, dgps_ops.error, grids.error, gcps.error, flights.error, remark
      ].some(Boolean);

      if (anyErr) return { ok: false };

      // Build payload
      const payload = {
        report_date: document.getElementById('report_date').value,
        site_id: Number(document.getElementById('site_id').value),
        drone_id: Number(document.getElementById('drone_id').value),
        base_height_m: Number(document.getElementById('base_height_m').value),
        pilot_name: document.getElementById('pilot_name').value.trim(),
        copilot_name: document.getElementById('copilot_name').value.trim(),
        dgps_used: dgps_used.list,
        dgps_operators: dgps_ops.list,
        grid_numbers: grids.list,
        gcp_points: gcps.list,
        remark: document.getElementById('remark').value.trim(),
        flights: flights.flights
      };
      return { ok: true, payload };
    }

    // ---- Preview flow ----
    function showPreview(payload) {
      const el = document.getElementById('preview_content');
      const totals = payload.flights.reduce((acc, f) => {
        acc.time += (Number(f.flight_time_min || f.t) || 0);
        acc.area += (Number(f.area_sq_km || f.a) || 0);
        return acc;
      }, {time:0, area:0});

      const pretty = {
        ...payload,
        flights: payload.flights.map(f => ({
          flight_time_min: f.flight_time_min ?? f.t,
          area_sq_km: f.area_sq_km ?? f.a,
          uav_rover_file: f.uav_rover_file ?? f.u,
          drone_base_file_no: f.drone_base_file_no ?? f.b
        })),
        totals: { total_time_min: totals.time, total_area_sq_km: Number(totals.area.toFixed(3)) }
      };

      el.textContent = JSON.stringify(pretty, null, 2);

      document.getElementById('form_card').classList.add('hidden');
      document.getElementById('preview_card').classList.remove('hidden');
    }

    document.getElementById('btn_preview').addEventListener('click', () => {
      const v = collectAndValidate();
      if (!v.ok) return;
      showPreview(v.payload);
    });

    document.getElementById('btn_edit').addEventListener('click', () => {
      document.getElementById('preview_card').classList.add('hidden');
      document.getElementById('form_card').classList.remove('hidden');
    });

    document.getElementById('btn_confirm').addEventListener('click', async () => {
      // No create endpoint in this phase
      alert('Submission endpoint is disabled for now. (Preview-only mode)');
      // tg?.close(); // Uncomment when you want to close after preview
    });

    // ---- Init ----
    (async function init() {
      try {
        // default date & one flight row
        document.getElementById('report_date').value = new Date().toISOString().slice(0,10);
        addFlightRow();

        await verifySession(); // gates non-employees
        await loadMasters();
      } catch (e) {
        console.error(e);
      }
    })();
  </script>
</body>
</html>