<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Drone Flight Data Entry</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; background: #f5f5f5; }
    h2 { color: #333; margin: 0 0 12px; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, select, textarea {
      width: 100%; max-width: 360px; padding: 8px; margin-top: 4px;
      border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;
      background: #fff;
    }
    .flight-section {
      border: 1px solid #ccc; padding: 12px; margin: 10px 0; background: #fff; border-radius: 6px;
    }
    .totals {
      background: #e6f7ff; padding: 10px; margin-top: 15px; border-radius: 6px; max-width: 360px;
    }
    button {
      margin-top: 16px; padding: 10px 16px; background: #007bff; border: none;
      color: #fff; font-size: 15px; border-radius: 6px; cursor: pointer;
    }
    button:hover { background: #0056b3; }
    .muted { color: #666; font-size: 12px; margin-top: 2px; max-width: 360px; }
    .error { color: #b00020; font-size: 12px; margin-top: 4px; }
    .card { background: #fff; border-radius: 10px; padding: 12px; box-shadow: 0 1px 3px rgba(0,0,0,.06); max-width: 420px; }
    .hidden { display: none; }
    .divider { height: 1px; background: #e5e7eb; margin: 14px 0; }
    .preview-list { list-style: none; padding: 0; margin: 0; }
    .preview-list li { margin: 6px 0; }
    table { border-collapse: collapse; width: 100%; max-width: 420px; }
    th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
    th { background: #f0f4ff; }
    .actions { display: flex; gap: 8px; }
    .link { background: #666; }
  </style>
</head>
<body>
  <h2>Drone Flight Data Entry</h2>

  <!-- FORM -->
  <div id="formCard" class="card">
    <!-- Site Name -->
    <label>Site Name:</label>
    <select id="siteName">
      <option value="">-- Select Site --</option>
    </select>
    <div class="error" id="err_siteName"></div>

    <!-- Date -->
    <label>Date:</label>
    <input type="date" id="date">
    <div class="error" id="err_date"></div>

    <!-- Drone used -->
    <label>Drone Used:</label>
    <select id="droneUsed">
      <option value="">-- Select Drone --</option>
    </select>
    <div class="error" id="err_droneUsed"></div>

    <!-- DGPS Used -->
    <label>DGPS Used:</label>
    <div class="muted">If multiple entries, separate them by <b>commas only</b>. (No spaces as separators)</div>
    <input type="text" id="dgpsUsed" placeholder="e.g. R4S - 314,DA2 - 739">
    <div class="error" id="err_dgpsUsed"></div>

    <!-- DGPS Operators -->
    <label>Name of DGPS Operators:</label>
    <div class="muted">If multiple entries, separate them by <b>commas only</b>.</div>
    <input type="text" id="dgpsOperators" placeholder="e.g. Alice,Bob">
    <div class="error" id="err_dgpsOperators"></div>

    <!-- Pilot / Copilot -->
    <label>Name of Pilot:</label>
    <input type="text" id="pilotName" placeholder="Enter Pilot Name">
    <div class="error" id="err_pilotName"></div>

    <label>Name of Copilot:</label>
    <input type="text" id="copilotName" placeholder="Enter Copilot Name">
    <div class="error" id="err_copilotName"></div>

    <!-- Number of Flights -->
    <label>No of Flights:</label>
    <select id="noOfFlights">
      <option value="">-- Select --</option>
      <option value="1">1</option><option value="2">2</option><option value="3">3</option>
      <option value="4">4</option><option value="5">5</option><option value="6">6</option>
      <option value="7">7</option><option value="8">8</option><option value="9">9</option>
      <option value="10">10</option>
    </select>
    <div class="error" id="err_noOfFlights"></div>

    <!-- Flight Details -->
    <div id="flightsContainer"></div>
    <div class="error" id="err_flights"></div>

    <!-- Grid Numbers -->
    <label>Grid Numbers / Block Number:</label>
    <div class="muted">If multiple entries, separate them by <b>commas only</b>.</div>
    <input type="text" id="gridNumbers" placeholder="e.g. H43R12A17,H43R12A22">
    <div class="error" id="err_gridNumbers"></div>

    <!-- GCP Points Covered -->
    <label>GCP Points Covered:</label>
    <div class="muted">If multiple entries, separate them by <b>commas only</b>.</div>
    <input type="text" id="gcpPoints" placeholder="e.g. CP1,CP2,CK1,CK2">
    <div class="error" id="err_gcpPoints"></div>

    <!-- Base Height (m) -->
    <label>Base Height (Mtr):</label>
    <input type="number" id="baseHeight" min="0" step="0.01">
    <div class="error" id="err_baseHeight"></div>

    <!-- Totals -->
    <div class="totals">
      <label>Total Area Covered (Sq km):</label>
      <input type="number" id="totalArea" readonly>
      <label>Total Flight Time (Min):</label>
      <input type="number" id="totalTime" readonly>
    </div>

    <!-- Remark -->
    <label>Remark:</label>
    <textarea id="remark" rows="3"></textarea>
    <div class="error" id="err_remark"></div>

    <div class="actions">
      <button id="btnPreview">Preview</button>
      <button class="link" id="btnClose">Close</button>
    </div>
  </div>

  <!-- PREVIEW -->
  <div id="previewCard" class="card hidden">
    <h3 style="margin:0 0 10px;">Preview</h3>
    <ul class="preview-list" id="previewList"></ul>

    <div class="divider"></div>
    <h4 style="margin:0 0 6px;">Flights</h4>
    <table id="flightsTable">
      <thead>
        <tr>
          <th>#</th>
          <th>Time (min)</th>
          <th>Area (sq km)</th>
          <th>UBX</th>
          <th>Base File</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="divider"></div>
    <div class="totals">
      <div><b>Total Time:</b> <span id="prevTotalTime">0</span> min</div>
      <div><b>Total Area:</b> <span id="prevTotalArea">0</span> sq km</div>
    </div>

    <div class="actions">
      <button id="btnConfirm">Confirm & Submit</button>
      <button class="link" id="btnEdit">Edit</button>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    tg?.expand();

    // --- Helpers ---
    function setErr(id, msg){ document.getElementById(id).textContent = msg || ''; }
    function clearErrors(){
      ['err_siteName','err_date','err_droneUsed','err_dgpsUsed','err_dgpsOperators',
       'err_pilotName','err_copilotName','err_noOfFlights','err_flights',
       'err_gridNumbers','err_gcpPoints','err_baseHeight','err_remark']
       .forEach(id => setErr(id,''));
    }

    function parseCommaListStrict(value){
      const raw = (value || '').trim();
      if (!raw) return { list: [], error: 'Required' };
      const spaceTokens = raw.split(/\s+/).filter(Boolean);
      if (spaceTokens.length > 1 && !raw.includes(',')) {
        return { list: [], error: 'Use commas to separate values (no spaces as separators)' };
      }
      const list = raw.split(',').map(s => s.trim()).filter(Boolean);
      if (list.length === 0) return { list: [], error: 'At least one value required' };
      return { list, error: null };
    }

    function updateTotals() {
      let totalTime = 0, totalArea = 0;
      document.querySelectorAll(".flightTime").forEach(input => {
        totalTime += Number(input.value) || 0;
      });
      document.querySelectorAll(".flightArea").forEach(input => {
        totalArea += Number(input.value) || 0;
      });
      document.getElementById("totalTime").value = totalTime;
      document.getElementById("totalArea").value = Number(totalArea).toFixed(3);
    }

    function generateFlights(){
      const count = Number(document.getElementById("noOfFlights").value);
      const container = document.getElementById("flightsContainer");
      container.innerHTML = "";
      if (!count) return;

      for (let i=1; i<=count; i++){
        const div = document.createElement("div");
        div.className = "flight-section";
        div.innerHTML = `
          <h3 style="margin:0 0 8px;">Flight ${i}</h3>
          <label>Flight Time (Min):</label>
          <input type="number" class="flightTime" min="1" step="1" oninput="updateTotals()">

          <label>Area Covered (Sq km):</label>
          <input type="number" class="flightArea" min="0.001" step="0.001" oninput="updateTotals()">

          <label>UAV Rover File (UBX No):</label>
          <input type="text" class="flightUbx" placeholder="UBX...">

          <label>Drone Base File No:</label>
          <input type="text" class="flightBase" placeholder="Base file...">
        `;
        container.appendChild(div);
      }
      updateTotals();
    }

    // --- Masters (sites & drones) ---
    async function loadMasters(){
      const res = await fetch('/api/masters');
      const data = await res.json();
      const siteSel = document.getElementById('siteName');
      const droneSel = document.getElementById('droneUsed');
      (data.sites || []).forEach(s => {
        const o = document.createElement('option');
        o.value = s.id; o.textContent = s.name;
        siteSel.appendChild(o);
      });
      (data.drones || []).forEach(d => {
        const o = document.createElement('option');
        o.value = d.id; o.textContent = d.name;
        droneSel.appendChild(o);
      });
    }

    // --- Verify session (blocks non-employees) ---
    async function verifySession(){
      const initData = tg?.initData || '';
      const res = await fetch('/api/verify', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ init_data: initData })
      });
      if (!res.ok){
        const d = await res.json().catch(()=>({detail:'verify failed'}));
        alert('Access denied: ' + (d.detail || 'verify failed')); tg?.close(); throw new Error('verify failed');
      }
      return res.json();
    }

    // --- Collect & validate ---
    function collectAndValidate(){
      clearErrors();
      const siteId = document.getElementById('siteName').value.trim();
      const date   = document.getElementById('date').value.trim();
      const droneId= document.getElementById('droneUsed').value.trim();
      const dgpsU  = document.getElementById('dgpsUsed').value;
      const dgpsO  = document.getElementById('dgpsOperators').value;
      const pilot  = document.getElementById('pilotName').value.trim();
      const copilot= document.getElementById('copilotName').value.trim();
      const nFlights = document.getElementById('noOfFlights').value.trim();
      const grids  = document.getElementById('gridNumbers').value;
      const gcps   = document.getElementById('gcpPoints').value;
      const baseH  = document.getElementById('baseHeight').value.trim();
      const remark = document.getElementById('remark').value.trim();

      if (!siteId) setErr('err_siteName','Required');
      if (!date) setErr('err_date','Required');
      if (!droneId) setErr('err_droneUsed','Required');

      const dgpsUsed = parseCommaListStrict(dgpsU);
      const dgpsOps  = parseCommaListStrict(dgpsO);
      const gridNums = parseCommaListStrict(grids);
      const gcpPts   = parseCommaListStrict(gcps);

      if (!pilot) setErr('err_pilotName','Required');
      if (!copilot) setErr('err_copilotName','Required');
      if (!nFlights) setErr('err_noOfFlights','Required');
      if (!baseH) setErr('err_baseHeight','Required');
      if (!remark) setErr('err_remark','Required');

      // Flights
      const sections = Array.from(document.querySelectorAll('.flight-section'));
      let flights = [];
      let flightsError = null;
      if (sections.length === 0){
        flightsError = 'Add number of flights';
      } else {
        for (let i=0;i<sections.length;i++){
          const sec = sections[i];
          const t = Number(sec.querySelector('.flightTime').value);
          const a = Number(sec.querySelector('.flightArea').value);
          const u = sec.querySelector('.flightUbx').value.trim();
          const b = sec.querySelector('.flightBase').value.trim();
          if (!t || t < 1){ flightsError = `Flight ${i+1}: time must be â‰¥ 1`; break; }
          if (!a || a <= 0){ flightsError = `Flight ${i+1}: area must be > 0`; break; }
          if (!u){ flightsError = `Flight ${i+1}: UBX required`; break; }
          if (!b){ flightsError = `Flight ${i+1}: Base file required`; break; }
          flights.push({ flight_time_min: t, area_sq_km: a, uav_rover_file: u, drone_base_file_no: b });
        }
      }
      if (flightsError) setErr('err_flights', flightsError);

      const anyErr = (
        !siteId || !date || !droneId || !pilot || !copilot || !nFlights || !baseH || !remark ||
        dgpsUsed.error || dgpsOps.error || gridNums.error || gcpPts.error || flightsError
      );
      if (anyErr) return { ok:false };

      return {
        ok: true,
        report: {
          report_date: date,
          site_id: Number(siteId),        // server now maps id -> name
          drone_id: Number(droneId),      // server now maps id -> name
          base_height_m: Number(baseH),
          pilot_name: pilot,
          copilot_name: copilot,
          dgps_used: dgpsUsed.list,
          dgps_operators: dgpsOps.list,
          grid_numbers: gridNums.list,
          gcp_points: gcpPts.list,
          remark
        },
        flights
      };
    }

    // --- Preview ---
    function showPreview(bundle){
      // Fill top list
      const L = document.getElementById('previewList');
      const r = bundle.report;
      L.innerHTML = '';
      const addLi = (label, value) => {
        const li = document.createElement('li');
        li.innerHTML = `<b>${label}:</b> ${value}`;
        L.appendChild(li);
      };
      // find selected text for site & drone
      const siteTxt = document.querySelector('#siteName option:checked')?.textContent || r.site_id;
      const droneTxt= document.querySelector('#droneUsed option:checked')?.textContent || r.drone_id;

      addLi('Date', r.report_date);
      addLi('Site Name', siteTxt);
      addLi('Drone Used', droneTxt);
      addLi('DGPS Used', r.dgps_used.join(', '));
      addLi('DGPS Operators', r.dgps_operators.join(', '));
      addLi('Pilot', r.pilot_name);
      addLi('Copilot', r.copilot_name);
      addLi('Grid Numbers', r.grid_numbers.join(', '));
      addLi('GCP Points', r.gcp_points.join(', '));
      addLi('Base Height (m)', r.base_height_m);
      addLi('Remark', r.remark);

      // Flights table
      const TB = document.querySelector('#flightsTable tbody');
      TB.innerHTML = '';
      let totalTime = 0, totalArea = 0;
      bundle.flights.forEach((f, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${f.flight_time_min}</td>
          <td>${Number(f.area_sq_km).toFixed(3)}</td>
          <td>${f.uav_rover_file}</td>
          <td>${f.drone_base_file_no}</td>
        `;
        TB.appendChild(tr);
        totalTime += Number(f.flight_time_min) || 0;
        totalArea += Number(f.area_sq_km) || 0;
      });
      document.getElementById('prevTotalTime').textContent = totalTime;
      document.getElementById('prevTotalArea').textContent = totalArea.toFixed(3);

      // also fill the totals box on the form
      document.getElementById('totalTime').value = totalTime;
      document.getElementById('totalArea').value = totalArea.toFixed(3);

      // Toggle
      document.getElementById('formCard').classList.add('hidden');
      document.getElementById('previewCard').classList.remove('hidden');
    }

    // --- Submit ---
    async function submitBundle(bundle){
      const initData = tg?.initData || '';
      const res = await fetch('/api/reports', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ init_data: initData, report: bundle.report, flights: bundle.flights })
      });
      if (!res.ok){
        const d = await res.json().catch(()=>({detail:'submit failed'}));
        throw new Error(d.detail || 'Submit failed');
      }
      return res.json();
    }

    // --- Wire up ---
    document.getElementById('noOfFlights').addEventListener('change', generateFlights);
    document.getElementById('btnClose').addEventListener('click', ()=> tg?.close());
    document.getElementById('btnPreview').addEventListener('click', ()=>{
      const v = collectAndValidate(); if (!v.ok) return; showPreview(v);
    });
    document.getElementById('btnEdit').addEventListener('click', ()=>{
      document.getElementById('previewCard').classList.add('hidden');
      document.getElementById('formCard').classList.remove('hidden');
    });
    document.getElementById('btnConfirm').addEventListener('click', async ()=>{
      try{
        const v = collectAndValidate(); if (!v.ok) { alert('Form has errors.'); return; }
        await submitBundle(v);
        alert('Report submitted successfully!');
        tg?.close();
      }catch(e){
        alert(e.message || 'Submit failed');
      }
    });

    // --- Init ---
    (async function init(){
      document.getElementById('date').value = new Date().toISOString().slice(0,10);
      try {
        await verifySession();
        await loadMasters();
      } catch(e) {
        console.error(e);
      }
    })();
  </script>
</body>
</html>
